---
title: "Initial explore"
author: "Julianna Renzi"
date: "10/17/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# for multidimentional stuff
require(vegan)
require(RVAideMemoire)
require(goeveg) # stress plot

require(worms) # for taxonomic information using the World Registry of Marine Species

require(tidyverse)
require(here)
require(calecopal)
# devtools::install_github("an-bui/calecopal") # nice California colors

require(RColorBrewer)



```

Initial explore


# Bring in data

```{r}
alldat <- read_csv(here("data/cafi_data_sheet_with_dropdown.csv"))
metadat <- read_csv(here("data/Coral_metadata.csv"))
```

Also the generic TL data:

```{r}
estimatedTL <- read_csv(here("data/TL_rough_analysis.csv"))
```


If you want to run it without any of the questionable corals:

```{r}
#alldat %>% 
#   filter(coral_id != 40 & coral_id != 25 & coral_id != 19) -> alldat
```



# Make a color palette

```{r}
colorz <- cal_palette(name = "superbloom2", n = 5, type = "discrete")
b.color <- colorz[1]
control.color <- colorz[2]
crab.color <- colorz[4]
n.color <- colorz[5]
```

# Get percent loss stats

```{r}
# pdf(here("figures/Aug28TL.pdf"), height = 4, width = 5.5)

estimatedTL %>% 
  mutate(Treatment = factor(Treatment, levels = c("Crab", "Both", "Control", "Nutrient"))) %>% 
  ggplot() +
  geom_boxplot(aes(x = factor(Treatment), y = Aug_28_estimate, color =Treatment), fill = "lightgray") +
  theme_classic() + 
  scale_color_manual(values = c(crab.color, b.color, control.color, n.color)) +
  geom_point(aes(x = Treatment, y = Aug_28_estimate), alpha = 0.5) +
  xlab("Treatment") +
  ylab("Tissue loss (%)") +
  theme(legend.position = "none",
        text = element_text(size=20),
      axis.text.x = element_text(angle=0))

# dev.off()


# and last time point:
estimatedTL %>% 
  ggplot() +
  geom_boxplot(aes(x = factor(Treatment), y = Percent_tissue_loss_July2023, fill = Treatment, color =Treatment)) +
  theme_classic() + 
  scale_fill_manual(values = brewer.pal(name = "Accent", n = 4)) +
  geom_point(aes(x = Treatment, y = Percent_tissue_loss_July2023), alpha = 0.5) +
  xlab("Treatment") +
  ylab("Percent tissue loss") +
  theme(legend.position = "none")

```

For just crabs

```{r}
# for crabs
estimatedTL %>% 
  ggplot() +
  geom_violin(aes(x = factor(Crab), y = Aug_28_estimate, fill = Crab)) +
  theme_classic() + 
  scale_fill_manual(values = c("#7FC97F", "#BEAED4")) +
  geom_point(aes(x = Crab, y = Aug_28_estimate), alpha = 0.5) +
  xlab("Crab present") +
  ylab("Percent tissue loss") +
  theme(legend.position = "none")

#  for later time point
estimatedTL %>% 
  ggplot() +
  geom_violin(aes(x = factor(Crab), y = Percent_tissue_loss_July2023, fill = Crab)) +
  theme_classic() + 
  scale_fill_manual(values = c("#7FC97F", "#BEAED4")) +
  geom_point(aes(x = Crab, y = Percent_tissue_loss_July2023), alpha = 0.5) +
  xlab("Crab present") +
  ylab("Percent tissue loss") +
  theme(legend.position = "none")
```

## Stats?

```{r}
gaus_tissue1 <- glm(Aug_28_estimate ~ Crab + Nutrients, data = estimatedTL)
  summary(gaus_tissue1) # nothing
  
gaus_tissue2 <- glm(Percent_tissue_loss_July2023 ~  Crab + Nutrients, data = estimatedTL)
  summary(gaus_tissue2) # close, wonder what this would be like if I did percent cover in a better way?
  

```




How many unique taxa names did I use?

```{r}
alldat %>% 
  select(search_term) %>% 
  unique() %>% 
  arrange(search_term) -> taxa

dim(taxa)
```

Can we attach the wormsID to these values?

```{r}
# alcl <- wormsbymatchnames("Arete indicus")

#  taxa %>% 
#    # do it just for the taxa that have search term level data
#    filter(!is.na(search_term)) %>% 
#    rowwise() %>% 
#    mutate(Alphia_id = wormsbymatchnames(search_term)$AlphiaID) %>% 
#    mutate(Family = wormsbymatchnames(search_term)$family) %>% 
#    mutate(Status = wormsbymatchnames(search_term)$status) -> wormz
#  # this is really slow so can save it as a CSV and read in as needed

# write_csv(wormz, here("data/worms.csv"))
wormz <- read_csv(here("data/worms.csv"))
```

Then make groupings for those we want at above family level. General groups are: hermit, worm, limpet, bivalve, amphipod, Tanaidacea. Think about adding in brittles?

```{r}
alldat %>% 
  select(-family) %>% # we want to make our own family
  left_join(wormz, by = "search_term") %>% 
  mutate(Taxa_group = case_when(type == "bivalve" ~ "Bivalve",
                                type == "hermit" ~ "Hermit",
                                type == "amphipod" ~ "Amphipod",
                                type == "limpet" ~ "Limpet",
                                type == "worm" ~ "Worm",
                                search_term == "Tanaidacea" ~ "Peracarid",
                                code == "HARA" ~ "Peracarid",
                                code == "OPEL" ~ "Brittle",
                                code == "BRDE" ~ "Brittle",
                                code == "OPSC" ~ "Brittle",
                                code == "OPER" ~ "Brittle",
                                code == "BRPI" ~ "Brittle",
                                code == "OPSE" ~ "Brittle",
                                code == "AMSQ" ~ "Brittle",
                                code == "MALO" ~ "Brittle",
                                code == "OPSA" ~ "Brittle",
                                code == "OPSP" ~ "Brittle",
                                search_term == "Ophiocoma" ~ "Brittle",
                                code == "OPPE" ~ "Brittle",
                                TRUE ~ Family)) %>% 
  # remove one unidentified snail (if the data change BE WARY OF THIS STEP)
  filter(!is.na(Taxa_group)) -> cafi_grouped

```

## Change Sm/Med/Lg to numeric

First look at distribution of data to get estimates for DAAR and DAFL size range

```{r}

cafi_grouped %>% 
  filter(cafi_size_mm != "Med" &
           cafi_size_mm != "XL" &
           cafi_size_mm != "Lg" &
           cafi_size_mm != "Sm") %>% 
  mutate(cafi_size_mm = as.numeric(cafi_size_mm)) -> fish_dist
```

Plot it/summarize for DAAR

```{r}
fish_dist %>% 
  filter(code == "DAAR") %>% 
  ggplot(aes(x = cafi_size_mm)) +
  geom_histogram()

fish_dist %>% 
  filter(code == "DAAR") %>% 
  select(cafi_size_mm) %>% summary() 
```

And for DAFL

```{r}
fish_dist %>% 
  filter(code == "DAFL") %>% 
  ggplot(aes(x = cafi_size_mm)) +
  geom_histogram()

fish_dist %>% 
  filter(code == "DAFL") %>% 
  select(cafi_size_mm) %>% summary() 
```

Let's set third quartile as large, max as extra large, mean as medium

```{r}
cafi_grouped %>% 
  mutate(cafi_size_mm = case_when(code == "DAFL" & cafi_size_mm == "Sm" ~ "18.50",
                                  code == "DAFL" & cafi_size_mm == "Med" ~ "31.17",
                                  code == "DAFL" & cafi_size_mm == "Lg" ~ "42.50",
                                  code == "DAFL" & cafi_size_mm == "XL" ~ "65.00",
                                  code == "DAAR" & cafi_size_mm == "Sm" ~ "7.00",
                                  code == "DAAR" & cafi_size_mm == "Med" ~ "10.69",
                                  TRUE ~ cafi_size_mm)) %>% 
  mutate(cafi_size_mm = as.numeric(cafi_size_mm)) -> cafi
```




# Explore


## Metadata

What about with points highlighted for remaining TRBI?

We know from initial measurements that all CAFI were at least 8mm. To account for potential measurement error, let's do 7.5mm and above

```{r}
cafi %>% 
  filter(search_term == "Trapezia bidentata") %>% 
  filter(cafi_size_mm >= 7.5) %>% 
  group_by(coral_id) %>% 
  summarize(TRBI_abundance = sum(count)) %>% 
  ungroup() -> lasting_TRBI
```

Join with metadata 

```{r}
metadat %>% 
  # decide to use 9_broken dimensions instead of unbroken
  mutate(Coral_ID = case_when(Coral_ID == "9_broken" ~ "9", 
                              TRUE ~ Coral_ID)) %>% 
  filter(Coral_ID != "9_unbroken") %>% 
  # make it a number
  mutate(Coral_ID = as.numeric(Coral_ID)) %>% 
  rename(coral_id = Coral_ID) %>% 
  mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) %>% 
  # add TRBI data
  full_join(lasting_TRBI, by = "coral_id") %>% 
  mutate(TRBI_abundance = replace_na(TRBI_abundance, 0)) -> metadatint
```


Summarize and join

```{r}

# and for abundance by taxa (but not size)
cafi_grouped %>% 
  group_by(coral_id, Taxa_group) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  full_join(metadatint) %>% 
  # get rid of NA goobs (ones we filtered out)
  filter(!is.na(Abundance)) -> abundcafiTaxa
```

```{r}
abundcafiTaxa %>% 
  mutate(Treatment = factor(Treatment, levels = c("Control", "Both", "Crab", "Nutrient"))) %>% 
  ggplot(aes(x = Treatment, y = Abundance, fill = Taxa_group)) +
  geom_bar(stat = "identity") +
  theme_bw()
```

Total abundance

```{r}
# for total abundance
alldat %>% 
  group_by(coral_id) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  full_join(metadatint) %>% 
  # get rid of NA goobs (ones we filtered out)
  filter(!is.na(Abundance)) -> allcafi

```

```{r}
# pdf(here("figures/totalabundance.pdf"), height = 4, width = 6.5)

allcafi %>% 
  mutate(Treatment = factor(Treatment, levels = c("Control", "Both", "Crab", "Nutrient"))) %>% 
  ggplot(aes(x = Treatment, y = Abundance)) +
  geom_boxplot() +
  geom_point(aes(x = Treatment, y = Abundance, color = as.factor(TRBI_abundance)), data = allcafi) +
  scale_color_manual(name = "Final crabs", values = c("lightgray", "orange", "red", "darkred")) +
  theme_bw() +
  theme(text = element_text(size=20),
      axis.text.x = element_text(angle=0))

# dev.off()
```

```{r}
mAb <- glm(Abundance ~ Crab + Nutrients + Crab:Nutrients + Coral_vol, family = "poisson", data = allcafi)
  summary(mAb) # significant but small?
```





## Recruitment shadow?

Are there more CAFI in different blocks?



You'd think Block 10 would have the most recruitment if it was a recruitment shadow?

```{r}
allcafi %>% 
  ggplot(aes(x = Block, y = Abundance, group = Nutrients, color = Nutrients)) +
  geom_point(aes(size = Coral_vol)) +
  scale_color_manual(values = c(control.color, crab.color)) +
  facet_wrap(~Crab) +
  theme_bw()

allcafi %>% 
  ggplot(aes(x = Block, y = Abundance, group = Block)) +
  geom_boxplot() +
  theme_bw() # hard to tell without sizes

```



Stats?
```{r}
recruit.m1 <- glm(Abundance ~ Nutrients + Crab + Coral_vol + Block + Crab:Nutrients,
                  data = allcafi, family = poisson)
  summary(recruit.m1)
```

What do the predictions say about the model?

```{r}
new.data <- expand_grid(Nutrients = c("Y", "N"),
                        Crab = c("Y", "N"),
                        Coral_vol = mean(allcafi$Coral_vol),
                        Block = c(1:10))



preds <- predict(recruit.m1, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = Block, y = Pred, color = Crab)) +
  ylab("Predicted CAFI abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  facet_wrap(~Nutrients) +
  geom_point() +
  theme_classic()

#ggsave(here("figures/predCAFIabundBlock.jpg"), width = 4.5, height = 3, dpi = 500)
```



## COMOs

Start with the COMOs because they were of interest

BUT this next code could only include corals that had at least one como--need to fix that (include zeros)

```{r}
all_ids <- tibble("coral_id" = 1:40)

# if you're running it without questionable ones:
#all_ids %>% 
#  filter(coral_id != 25 &
#           coral_id != 19 &
#           coral_id != 40) -> all_ids
```

```{r}
alldat %>% 
  filter(search_term == "Coralliophila monodonta") %>% 
  group_by(coral_id, cafi_size_mm) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) -> comos
```




Attach to metadata

First clean a little and add metadata

```{r}


# order it

metadatint$Treatment <- factor(metadatint$Treatment, levels=c("Crab", "Both", "Nutrient", "Control"))
```

What about with points highlighted for remaining TRBI?


```{r}
comos %>% 
  left_join(metadatint, by = c("coral_id")) -> comos_size
  # calculate volume (I think this is done earlier)
  #mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> comos_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
comos_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol, TRBI_abundance) %>% 
  summarize(Abundance = sum(Abundance)) -> comos_count
```


### Plot it

```{r}
comos_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_classic()

# versus..
comos_count %>% 
  ggplot(aes(x = Treatment, y = as.integer(Abundance), color = Treatment)) +
  ylab("COMO abundance") +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  geom_boxplot() +
  theme_classic()



# pdf(here("figures/comoTRBIabundance.pdf"), height = 4, width = 6.5)

comos_count %>% 
  mutate(Treatment = factor(Treatment, levels = c("Both", "Crab", "Control", "Nutrient"))) %>% 
  ggplot(aes(x = Treatment, y = as.integer(Abundance))) +
  geom_boxplot() +
  geom_point(aes(x = Treatment, y = Abundance, color = as.factor(TRBI_abundance)), data = comos_count) +
  scale_color_manual(name = "Final crabs", values = c("lightgray", "orange", "red", "darkred")) +
  theme_bw() +
  ylab("COMO abundance") +
  theme(text = element_text(size=20),
      axis.text.x = element_text(angle=0))

# dev.off()


```

```{r}
comos_count %>% 
  ggplot(aes(x = Coral_vol), color = Treatment) +
  geom_density() +
  facet_wrap(.~Treatment) +
  theme_classic()
```


### Maybe stats?

Is there a difference in the volume of corals between treatments?

```{r}
lm.size <- lm(Coral_vol ~ Treatment, data = comos_count)
  summary(lm.size) # YAY!
```

Can also plot this:

```{r}
# pdf(here("figures/coralvol_vs_abundance.pdf"), height = 4, width = 7.5)

allcafi %>% 
  ggplot(aes(x = Coral_vol, y = Abundance, color = Treatment)) +
  geom_point() +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  #geom_smooth(method = "lm", color = b.color) +
  ylab("Total symbiont abundance") +
  xlab("Coral volume (cm^3)") +
  theme_bw() +
  theme(text = element_text(size=20),
      axis.text.x = element_text(angle=0))

# dev.off()
```


Is there a difference in COMO abundance?

```{r}
m.como <- glm(Abundance ~ Crab + Nutrients + Crab:Nutrients + Block +  Coral_vol, 
              family = poisson, data = comos_count)
  summary(m.como)
  
# if we change it so 40 is not crab
comos_count %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.como <- glm(Abundance ~ Crab + Nutrients + Coral_vol + Crab:Nutrients + Block, family = poisson, data = tst)
  summary(m.como)
```

What do the predictions say about the model?

```{r}
new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"), 
                        Coral_vol = mean(comos_count$Coral_vol), 
                        Block = c(1:10))


preds <- predict(m.como, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# block plot
pred.df %>% 
  ggplot(aes(x = Block, y = Pred, color = Crab)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  facet_wrap(~Nutrients) +
  theme_classic()

# pdf(here("figures/predCOMO.pdf"), width = 7.5, height = 5.5)
# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, fill = Crab)) +
  ylab("Predicted COMO abundance") +
  scale_fill_manual(values = c(control.color, crab.color)) +
  geom_boxplot() +
  theme_bw() +
  theme(text = element_text(size=20))

# dev.off()


# ggsave(here("figures/predCOMOabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

Could also re-plot this way:

```{r}
comos_count %>% 
  ggplot(aes(x = Nutrients, y = as.integer(Abundance), fill = Crab)) +
  ylab("COMO abundance") +
  scale_fill_manual(values = c(control.color, crab.color)) +
  geom_boxplot() +
  theme_classic()

#ggsave(here("figures/COMOabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

Or: 

```{r}
comos_count %>% 
  ggplot(aes(x = Nutrients, y = as.integer(Abundance))) +
  ylab("COMO abundance") +
  geom_boxplot() +
  theme_classic()
```

### With TRBIs?

```{r}
comos_count %>% 
  ggplot(aes(x = TRBI_abundance, y = Abundance, group = TRBI_abundance, color = Nutrients)) +
  geom_boxplot() +
  geom_point() +
  facet_wrap(~Crab) +
  theme_bw()
```


```{r}
m.comoTRB <- glm(Abundance ~ TRBI_abundance + Crab + Nutrients + Block + Coral_vol + TRBI_abundance:Crab + Nutrients:Crab + TRBI_abundance:Nutrients, 
              family = poisson, data = comos_count)
  summary(m.comoTRB)
  # don't know that it makes sense to include TRBI and nutrients in the same model because only like 1 data point for TRBI and nutrients

```

What do the predictions say about the model?

```{r}
new.data <- expand_grid(Nutrients = c("Y", "N"),
                        Coral_vol = mean(comos_count$Coral_vol),
                        Crab = c("Y", "N"),
                        TRBI_abundance = seq(0, 3),
                        Block = seq(1, 10))
  


preds <- predict(m.comoTRB, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Pred)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, n.color)) +
  xlab("Original TRBI remaining") +
  theme_classic()

# ggsave(here("figures/predCOMOabundTRBI.jpg"), width = 4.5, height = 3, dpi = 500)
```


Just plot abundances?

```{r}
# pdf(here("figures/originalCrabCOMO.pdf"), height = 4, width = 7)

comos_count %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Abundance)) +
  ylab("COMO abundance") +
  #scale_fill_manual(values = c(control.color, n.color)) +
   geom_boxplot() +
  geom_point(aes(color = Treatment), data = comos_count) +
  scale_color_manual(values = c(crab.color, b.color, n.color, control.color)) +
  xlab("Number of original crabs") +
  theme_classic() +
  theme(text = element_text(size=20),
      axis.text.x = element_text(angle=0))

# dev.off()

# ggsave(here("figures/COMOabundTRBI.jpg"), width = 4.5, height = 3, dpi = 500)
```

```{r}
comos_count %>% 
  group_by(TRBI_abundance) %>% 
  summarize(Mean_COMO = mean(Abundance),
            SD_COMO = sd(Abundance),
            N_COMO = n())
```



## DAFLs

```{r}
cafi %>% 
  filter(search_term == "Dascyllus flavicaudus") %>% 
  group_by(coral_id, cafi_size_mm) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) -> dafls
```



Attach to metadata

```{r}
dafls %>% 
  left_join(metadatint, by = c("coral_id")) %>% 
  # calculate volume
  mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> dafls_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
dafls_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance)) -> dafls_count
```


### Plot it

```{r}
dafls_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_classic()

# versus..
dafls_count %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
   ylab("DAFL abundance") +
   scale_fill_manual(values = c(control.color, crab.color)) +
   geom_boxplot() +
   theme_classic()

# ggsave(here("figures/DAFLabund.jpg"), width = 4.5, height = 3, dpi = 500)



# versus

```


### What about small DAFLs?

```{r}
hist(dafls_size$cafi_size_mm) # maybe like, under 3 cm?

dafls_size %>% 
  select(coral_id, cafi_size_mm, Abundance) %>% 
  filter(cafi_size_mm <= 30) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) %>% 
  left_join(metadatint, by = "coral_id") %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol, TRBI_abundance) %>% 
  summarize(Wittle_abundance = sum(Abundance)) -> bb_dafls
```

```{r}
bb_dafls %>% 
   ggplot(aes(x = Nutrients, y = Wittle_abundance, fill = Crab)) +
   ylab("Wittle DAFL abundance (<=3cm)") +
   scale_fill_manual(values = c(control.color, crab.color)) +
   geom_boxplot() +
   theme_classic()

# ggsave(here("figures/lilDAFLabund.jpg"), width = 4.5, height = 3, dpi = 500)
```



### Maybe stats?

Is there a difference in DAFL abundance?

```{r}
m.dafl <- glm(Abundance ~ Nutrients + Coral_vol + Block, family = poisson, data = dafls_count)
  summary(m.dafl) 
  
# if we change it so 40 is not crab
dafls_count %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.dafl <- glm(Abundance ~ Crab + Nutrients + Coral_vol, family = poisson, data = tst)
  summary(m.dafl)

```

What do the predictions say about the model?

```{r}
new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"),
                        Coral_vol = mean(dafls_count$Coral_vol),
                        Block = c(1:10))



preds <- predict(m.dafl, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot block
pred.df %>% 
  ggplot(aes(x = Block, y = Pred, color = Crab)) +
  ylab("Predicted DAFL abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  facet_wrap(~Nutrients) +
  theme_classic()

# plot
pdf(here("figures/DAFL_modpred.pdf"), height = 5, width = 7)

pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, fill = Nutrients)) +
  ylab("Predicted DAFL abundance") +
  scale_fill_manual(values = c(n.color, control.color)) +
  geom_boxplot() +
  theme_classic() +
  theme(text = element_text(size=20))

dev.off()

 # ggsave(here("figures/predDAFLabund.jpg"), width = 4.5, height = 3, dpi = 500)
```


For lil guyz

```{r}
m.lil.dafl <- glm(Wittle_abundance ~ Crab + Nutrients + Coral_vol + Block, family = poisson, data = bb_dafls)
  summary(m.lil.dafl) # hmmm interesting--crabs and nutrients are good and seem to be additive. Not sure I understand why. Size didn't seem to matter so much?
  
# test  coral 40
bb_dafls %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.lil.dafl <- glm(Wittle_abundance ~ Crab + Nutrients + Coral_vol + Block, family = poisson, data = tst)
  summary(m.lil.dafl)
```

What do the predictions say about the model?

```{r}
new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"),
                        Coral_vol = mean(bb_dafls$Coral_vol),
                        Block = c(1:10))



preds <- predict(m.lil.dafl, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot block
pred.df %>% 
  ggplot(aes(x = Block, y = Pred, color = Crab)) +
  ylab("Predicted wittle DAFL abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  facet_wrap(~Nutrients) +
  theme_classic()

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted DAFL abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic()

# ggsave(here("figures/predDAFLabund.jpg"), width = 4.5, height = 3, dpi = 500)
```


Is the crab real?

```{r}
bb_dafls %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Wittle_abundance, fill = Crab)) +
  geom_boxplot() +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("Wittle DAFL abundance (<=3cm)") +
  xlab("Original TRBI remaining") +
  geom_point() +
  theme_classic()
 
# ggsave(here("figures/lilDAFLTRBIabund.jpg"), width = 4.5, height = 3, dpi = 500) 
```



For big guyz

```{r}
dafls_size %>% 
  select(coral_id, cafi_size_mm, Abundance) %>% 
  filter(cafi_size_mm > 30) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) %>% 
  left_join(metadatint, by = "coral_id") %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Big_abundance = sum(Abundance)) -> big_dafls


```

```{r}
big_dafls %>% 
   ggplot(aes(x = Nutrients, y = Big_abundance, fill = Crab)) +
   ylab("Bigger DAFL abundance (>3cm)") +
   scale_fill_manual(values = c(control.color, crab.color)) +
   geom_boxplot() +
   theme_classic()

# ggsave(here("figures/bigDAFLabund.jpg"), width = 4.5, height = 3, dpi = 500) 
```

```{r}
m.big.dafl <- glm(Big_abundance ~ Crab + Nutrients + Coral_vol + Block, family = poisson, data = big_dafls)
  summary(m.big.dafl) # Hmmm interesting there actually is an effect of nutrients and volume; also no effect of block which is interesting
  
# test  coral 40
big_dafls %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.big.dafl <- glm(Big_abundance ~ Crab + Nutrients + Coral_vol, family = poisson, data = tst)
  summary(m.big.dafl)
```


### What do big vs. small DAFLs look like wrt volume?

- Big guyz

```{r}
big_dafls %>% 
  ggplot(aes(x = Coral_vol, y = Big_abundance, color = Nutrients)) +
  geom_point() +
  scale_color_manual(values = c(control.color, n.color)) +
  xlab("Coral volume") +
  ylab("Bigger DAFL abundance (>3cm)") +
  theme_classic()

ggsave(here("figures/bigDAFLabundSize.jpg"), width = 4.5, height = 3, dpi = 500) 
```

Small guyz 

```{r}
bb_dafls %>% 
  ggplot(aes(x = Coral_vol, y = Wittle_abundance, color = Nutrients)) +
  scale_color_manual(values = c(control.color, n.color)) +
  xlab("Coral volume") +
  ylab("Wittle DAFL abundance (<=3cm)") +
  geom_point() +
  theme_classic()

ggsave(here("figures/lilDAFLabundSize.jpg"), width = 4.5, height = 3, dpi = 500) 
```

- Size

```{r}
cafi %>% 
  filter(search_term == "Dascyllus flavicaudus") %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(count1 = case_when(is.na(count) ~ 0,
                               TRUE ~ count))  %>%
  left_join(metadatint, by = c("coral_id")) %>% 
  uncount(count1) -> dafl_uncount
  


dafl_uncount %>% 
 # filter(cafi_size_mm>3) %>% 
  ggplot(aes(x = cafi_size_mm, y = Coral_vol, color = Nutrients)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic()
```

Stats?

```{r}
m.daflsize <- glm(cafi_size_mm ~ Crab + Coral_vol + Nutrients + Block, data = dafl_uncount, family = gaussian) # now there's a big effect of block, where bigger fish are closer to the crest? But no effect of nutrients 
  summary(m.daflsize)
```

Block?

```{r}
dafl_uncount %>% 
 # filter(cafi_size_mm>3) %>% 
  ggplot(aes(x = Block, y = cafi_size_mm, color = Nutrients)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic()
```





# Alpheidae


```{r}
cafi %>% 
  filter(Family == "Alpheidae") %>% 
  group_by(coral_id, cafi_size_mm) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() -> alpheids
```



Attach to metadata

```{r}
alpheids %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) %>% 
  left_join(metadatint, by = c("coral_id")) %>% 
  # calculate volume
  mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> alpheids_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
alpheids_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance)) -> alpheids_count
```


### Plot it

```{r}
alpheids_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_bw()

# versus..
alpheids_count %>% 
  ggplot(aes(x = Treatment, y = as.integer(Abundance), fill = Treatment)) +
  geom_boxplot() +
  theme_bw()



```

```{r}
alpheids_count %>% 
  ggplot(aes(x = Coral_vol), color = Treatment) +
  geom_density() +
  facet_wrap(.~Treatment) +
  theme_bw()
```

```{r}
alpheids_count %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
    ylab("Alpheid abundance") +
    scale_fill_manual(values = c(control.color, crab.color)) +
    geom_boxplot() +
    theme_classic()

# ggsave(here("figures/Alpheidabund.jpg"), width = 4.5, height = 3, dpi = 500)
```


### Stats?

Is there a difference in Alpheid abundance?

```{r}
m.alpheid <- glm(Abundance ~ Crab + Nutrients + Nutrients:Crab + Coral_vol + Block, family = poisson, data =  alpheids_count)
  summary(m.alpheid) # whuttt
  
# if we change it so 40 is not crab
alpheids_count %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.alpheid <- glm(Abundance ~ Crab + Nutrients + Coral_vol + Block, family = poisson, data = tst)
  summary(m.alpheid) # hmmm 40 was really influential here

```

Predict? 

```{r}
new.data <- alpheids_count[,c("Crab", "Nutrients")]
new.data$Coral_vol <- mean(alpheids_count$Coral_vol)

preds <- predict(m.alpheid, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted Alpheid abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic()

# ggsave(here("figures/predAlpheidabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

## Palaemonidae


```{r}
cafi %>% 
  filter(Family == "Palaemonidae") %>% 
  group_by(coral_id, cafi_size_mm) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() -> palaemonids
```



Attach to metadata

```{r}
palaemonids %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) %>%
  left_join(metadatint, by = c("coral_id")) %>% 
  # calculate volume
  mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> palaemonids_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
palaemonids_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance)) -> palaemonids_count
```


### Plot it

```{r}
palaemonids_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_bw()

# versus..
palaemonids_count %>% 
  ggplot(aes(x = Treatment, y = as.integer(Abundance), fill = Treatment)) +
  geom_boxplot() +
  theme_bw()



```

```{r}
palaemonids_count %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
    ylab("Palaemonid abundance") +
    scale_fill_manual(values = c(control.color, crab.color)) +
    geom_boxplot() +
    theme_classic()

# ggsave(here("figures/Palaemonidabund.jpg"), width = 4.5, height = 3, dpi = 500)


```


### Stats?

Is there a difference in Palaemonid abundance?

```{r}
m.palaemonid <- glm(Abundance ~ Crab + Nutrients + Nutrients:Crab + Block + Coral_vol, family = poisson, data =  palaemonids_count)
  summary(m.palaemonid)  
   
# if we change it so 40 is not crab
palaemonids_count %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

m.palaemonid <- glm(Abundance ~ Crab + Nutrients + Coral_vol + Block + Crab:Nutrients, family = poisson, data = tst)
  summary(m.palaemonid) # not a huge change

```


What do the predictions say?

```{r}
new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"),
                        Coral_vol = mean(palaemonids_count$Coral_vol),
                        Block = c(1:10))


preds <- predict(m.palaemonid, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# block plot
pred.df %>% 
  ggplot(aes(x = Block, y = Pred, color = Crab)) +
  ylab("Predicted Palaemonid abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  facet_wrap(~Nutrients) +
  theme_classic()

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted Palaemonid abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic()


# ggsave(here("figures/PredPalaemonidabund.jpg"), width = 4.5, height = 3, dpi = 500)
```


#### Is this correlated with alpheid abundnace?

- Make a joint df

```{r}
alpheids_count %>% 
  rename(Alpheid_abund = Abundance) %>% 
  ungroup() %>% 
  select(Alpheid_abund, coral_id) -> intdf


palaemonids_count %>% 
  rename(Palaemonid_abund = Abundance) %>% 
  full_join(intdf, by = c("coral_id")) -> alphPalae
```

- Plot

```{r}
alphPalae %>% 
  ggplot(aes(x = Palaemonid_abund, y = Alpheid_abund)) +
  geom_point() +
  theme_bw()
```

### TRBI highlight 

What about with points highlighted for remaining TRBI?

We know from initial measurements that all CAFI were at least 8mm. To account for potential measurement error, let's do 7.5mm and above

```{r}
cafi %>% 
  filter(search_term == "Trapezia bidentata") %>% 
  filter(cafi_size_mm >= 7.5) %>% 
  left_join(metadat9, by = "coral_id") %>% 
  group_by(coral_id) %>% 
  summarize(TRBI_abundance = sum(count)) %>% 
  ungroup() -> lasting_TRBI
```

```{r}
alphPalae %>% 
  full_join(lasting_TRBI, by = "coral_id") %>% 
  mutate(TRBI_abundance = replace_na(TRBI_abundance, 0)) -> alphPalaeTRBI
```

- Plot

```{r}
alphPalaeTRBI %>% 
  ggplot(aes(x = Palaemonid_abund, y = Alpheid_abund, color = as.factor(TRBI_abundance))) +
  geom_point() +
  facet_wrap(~Nutrients) +
  theme_bw()


alphPalaeTRBI %>% 
  ggplot(aes(x = TRBI_abundance, y = Palaemonid_abund, color = as.factor(TRBI_abundance))) +
  geom_boxplot() +
  theme_bw()
```

```{r}
mtst <- glm(Palaemonid_abund ~  TRBI_abundance + Coral_vol + Block, family = poisson, data = alphPalaeTRBI)
  summary(mtst)
```

What do the predictions say?

```{r}
new.data <- expand.grid(Palaemonid_abund = seq(from = min(alphPalaeTRBI$Palaemonid_abund), to = max(alphPalaeTRBI$Palaemonid_abund), length.out = 20), 
                        Alpheid_abund = seq(from = min(alphPalaeTRBI$Alpheid_abund), to = max(alphPalaeTRBI$Alpheid_abund), length.out = 20),
                        Coral_vol = mean(alphPalaeTRBI$Coral_vol),
                        TRBI_abundance = c(0, 1, 2, 3),
                        Nutrients = c("Y", "N")) 

  
  
  
preds <- predict(mtst, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Pred)) +
  ylab("Predicted Palaemonid abundance") +
  xlab("Original TRBI remaining") +
  #scale_color_manual(values = c(control.color, n.color)) +
  geom_point() +
  #facet_wrap(~Nutrients) +
  theme_classic()


# what's the difference?
pred.df %>% group_by(TRBI_abundance) %>% summarize(meanPred = mean(Pred))


 # ggsave(here("figures/PredPalaemonidTRBIabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

Plot actual differences?

```{r}
alphPalaeTRBI %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Palaemonid_abund, fill = Nutrients)) +
    ylab("Palaemonid abundance") +
    scale_fill_manual(values = c(control.color, n.color)) +
    geom_boxplot() +
  geom_point(aes(x = as.factor(TRBI_abundance), y = Palaemonid_abund, color = Nutrients)) +
  scale_color_manual(values = c(control.color, n.color)) +
  xlab("Original TRBI remaining") +
    theme_classic()

# ggsave(here("figures/PalaemonidTRBIabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

### Repeat for alpheid


```{r}
m.AlphTRBI <- glm(Alpheid_abund ~  TRBI_abundance + Nutrients + Coral_vol + TRBI_abundance:Nutrients, family = poisson, data = alphPalaeTRBI)
  summary(m.AlphTRBI)
```

What do the predictions say?

```{r}
new.data <- expand.grid(Palaemonid_abund = seq(from = min(alphPalaeTRBI$Palaemonid_abund), to = max(alphPalaeTRBI$Palaemonid_abund), length.out = 20), 
                        Alpheid_abund = seq(from = min(alphPalaeTRBI$Alpheid_abund), to = max(alphPalaeTRBI$Alpheid_abund), length.out = 20),
                        Coral_vol = mean(alphPalaeTRBI$Coral_vol),
                        TRBI_abundance = c(0, 1, 2, 3),
                        Nutrients = c("Y", "N")) 

  
  
  
preds <- predict(m.AlphTRBI, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Pred, color = Nutrients)) +
  ylab("Predicted Alpheid abundance") +
  xlab("Original TRBI remaining") +
  scale_color_manual(values = c(control.color, n.color)) +
  geom_point() +
  #facet_wrap(~Nutrients) +
  theme_classic()


# ggsave(here("figures/PredAlpheidTRBIabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

Plot actual differences?

```{r}
alphPalaeTRBI %>% 
  ggplot(aes(x = as.factor(TRBI_abundance), y = Alpheid_abund, fill = Nutrients)) +
    ylab("Alpheid abundance") +
    scale_fill_manual(values = c(control.color, n.color)) +
    geom_boxplot() +
  geom_point(aes(x = as.factor(TRBI_abundance), y = Alpheid_abund, color = Nutrients)) +
  scale_color_manual(values = c(control.color, n.color)) +
  xlab("Original TRBI remaining") +
    theme_classic()

# ggsave(here("figures/AlpheidTRBIabund.jpg"), width = 4.5, height = 3, dpi = 500)
```

## Galathea


```{r}
cafi %>% 
  filter(Family == "Galatheidae") %>% 
  group_by(coral_id, cafi_size_mm) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() -> galatheids
```



Attach to metadata

```{r}
galatheids %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance)) %>%
    left_join(metadatint, by = c("coral_id")) %>% 
  # calculate volume
  mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> galatheids_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
galatheids_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance)) -> galatheids_count
```


### Plot it

```{r}
galatheids_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_bw() +
  geom_vline(xintercept = 7.5) + 
  xlab("GAMA body length (mm)") +
  ylab("Count") # bigger ones in nutrient?

ggsave(here("figures/GAMAsize.jpg"), width = 4.5, height = 3, dpi = 500)

# versus..
galatheids_count %>% 
  ggplot(aes(x = Treatment, y = as.integer(Abundance), fill = Treatment)) +
  geom_boxplot() +
  theme_bw()



```

```{r}
galatheids_count %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
    ylab("Galatheid abundance") +
    scale_fill_manual(values = c(control.color, crab.color)) +
    geom_boxplot() +
    theme_classic()

# ggsave(here("figures/Galatheidabund.jpg"), width = 4.5, height = 3, dpi = 500)


```


### Stats?

Is there a difference in Galatheid abundance?

```{r}
m.galatheid <- glm(Abundance ~ Crab + Nutrients + Nutrients:Crab + Coral_vol + Block, family = poisson, data =  galatheids_count)
  summary(m.galatheid)  
  
# if we change it so 40 is not crab
galatheids_count %>% 
  mutate(Crab = case_when(coral_id == 40 ~ "N",
                          TRUE ~ Crab)) -> tst

# or for 25
galatheids_count %>% 
  filter(coral_id != 25) -> tst

m.galatheid <- glm(Abundance ~ Crab + Nutrients + Coral_vol + Block + Crab:Nutrients, family = poisson, data = tst)
  summary(m.galatheid) # not a huge change



```


What do the predictions say?

```{r}
new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"),
                        Coral_vol = mean(galatheids_count$Coral_vol),
                        Block = c(1:10))

preds <- predict(m.galatheid, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted Galatheid abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_boxplot() +
  theme_classic()


# ggsave(here("figures/PredGalatheidabund.jpg"), width = 4.5, height = 3, dpi = 500)
```



# Try multidimensional approach

Making the NMDS: https://cougrstats.wordpress.com/2019/12/11/non-metric-multidimensional-scaling-nmds-in-r/

Testing differences: https://www.introranger.org/post/ord-groups-gradients/

Another options: https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/comment-page-1/

## Make a species matrix

```{r}
cafi %>% 
  group_by(coral_id, Taxa_group) %>% 
  # get abundance per taxa and coral
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = Taxa_group, values_from = Abundance) %>% 
  # replace NA's with zeros
  mutate_all(~replace(., is.na(.), 0)) -> spp_matrix_name

spp_matrix_name %>% 
  # get rid of ID column
  select(-coral_id) -> spp_matrix_wide # no coral_ID
```

What to do with rare species?

- "Addressing the removal of rare species in multivariate bioassessments: The impact of methodological choices" by Poos and Jackson (2012) suggests leaving in all rare spp
- Comments on this blog (https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/comment-page-1/) made me think it's probably at least removing families that only appear in one coral head

```{r}
# see how many columns have just one occurence

#colSums(spp_matrix_wide != 0) > 1

spp_mat_rare <- spp_matrix_wide[, colSums(spp_matrix_wide != 0) >= 2] # at least 2 occurrences (5% of samples)

# spp_mat_rare <- spp_matrix_wide
  
```

# Write community CSVs for Adrian's code

```{r}
# need to update above code so cafi object has all corals
metadatint %>% 
  select(coral_id, Block, Treatment, Crab, Nutrients, Circumference_cm, Coral_vol) %>% 
  full_join(TRBI_endAbund) %>% 
  mutate(TRBI_abundance = replace_na(TRBI_abundance, 0)) %>% 
  full_join(spp_matrix_name) -> spp_mat_fam_all


# write_csv(spp_mat_fam_all, here("generated_data/spp_mat_fam_all.csv"))

# or do with just the more obvious corals
spp_mat_fam_all %>% 
  full_join(TRBI_endAbund) %>% 
  mutate(TRBI_abundance = replace_na(TRBI_abundance, 0)) %>% 
  filter(coral_id != 25 &
           coral_id != 19 &
           coral_id != 40) -> spp_mat_fam_noWeirdos

# write_csv(spp_mat_fam_all, here("generated_data/spp_mat_fam_No251940.csv"))

```


# Calculate distance

```{r}
nmds_bdd <- metaMDS(comm = spp_mat_rare[-25,], # community matrix, but exclude the dead coral (25) 
                    ## get rid of the -25 part if you're doing it without 25, 40, and 19
                    k = 3, # chosen based on the scree plot
                    distance = "bray", # bray-curtis distance
                    try = 1500) # number of iterations
                    
```




See everything we can pull out:

```{r}
names(nmds_bdd)

nmds_bdd$ndim # number of axes created
nmds_bdd$converged # did it converge?
nmds_bdd$stress # what's the stress of the final solution
nmds_bdd$distance # type of distance
nmds_bdd$tries # number of random initial configuration tried
nmds_bdd$points # scores for each sample (coral)
nmds_bdd$species # scores for variables/species

# and can plot simply:
plot(nmds_bdd) # open black circles correspond to samples and red crosses indicate variables

```


# Plot NMDS

```{r}
# create a data frame of the scores from the individual sites.
# This data frame will contain x and y values for where sites are located.
data_scores <- as.data.frame(scores(nmds_bdd))
```

Now attached metadata

```{r}
data_scores <- cbind(data_scores, spp_matrix_name[-25,"coral_id"])

# add other data 
data_scores %>% 
  left_join(metadat9, by = "coral_id") -> data_scores
```

Add the scores for species data

```{r}
species_scores <- as.data.frame(scores(nmds_bdd, "species"))
```


Add a column equivalent to the row name

```{r}
species_scores$species <- rownames(species_scores)
```

Build the plot

```{r}
ggplot() +
  geom_point(data = data_scores, aes(x = NMDS1, y = NMDS2, 
                                     color = Treatment), size = 3) +
  annotate(geom = "label", x = -.1, y = .6, size = 10,
           label = paste("Stress: ", round(nmds_bdd$stress, digits = 3))) +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  theme_classic() +
  theme(legend.position = "right",
        text = element_text(size = 24))
```


Or try this way: https://stats-uoa.github.io/BIOSCI220/multivariate-data-analysis.html

```{r}
# for corals
sample_scores <- as.data.frame(nmds_bdd$points)


# if you're running without weird corals:
# metadat9 %>% 
#   filter(coral_id != 40 & coral_id != 25 & coral_id != 19) -> metadat9


# add metadata
sample_scores <- cbind(sample_scores, metadat9)
```

And for species:

```{r}
spp_scores <- as.data.frame(nmds_bdd$species)
spp_scores$Species <- rownames(spp_scores)
```

Then plot:

```{r}
ggplot() +
  # the data points for each sample using the scores created in metaMDS function
  geom_point(data = sample_scores, aes(x = MDS1, y = MDS2, 
                                     color = Treatment), size = 3) +
  # create more appropriate x and y axis labels 
  xlab("nMDS1") +
  ylab("nMDS2") +
  # what colours would we like?
  scale_color_manual(values = inferno(15)[c(3, 8, 16, 11)],
                     name = "Treatment") +
  # add stress label to the plot, indicating the label position
  #annotate(geom = "label", x = -1.75, y = 2.75, size = 6,
   #        label = paste("Stress: ", round(nmds_bdd$stress, digits = 3))) +
  theme_classic() + # choosing a theme
  theme(legend.position = "right",
        text = element_text(size = 10)) # position and size of legend
```

# Scree/stress plot

```{r}
dimcheckMDS(spp_mat_rare, distance = "bray", k=6) # k is max dimensions and default is 6
```

Also do a Shepard diagram

```{r}
stressplot(nmds_bdd)
```

# 3D plot

```{r}
require(vegan3d) # need to also download xQuartz
```

Use ordiplot3d

```{r}
# sample scores data
data_scores_3d <-scores(nmds_bdd, display = "sites")

# variable scores data
species_scores_3d <-scores(nmds_bdd, display = "species")
```


```{r}
#static 3-D variable scores plot
out <- ordiplot3d(species_scores_3d, col = "red", ax.col= "black", pch = 18)
text(out$xyz.convert(species_scores_3d), rownames(species_scores_3d), pos=1)
```

Try rotatable version

```{r}
#rotatable 3-D sample scores plot with sample points
ordirgl(data_scores_3d, col = "red", type = "p", ax.col= "black", pch = 18)
# to change points to sample labels use type = "t"

#rotatable 3-D variable scores plot with variable labels
ordirgl(species_scores_3d, col = metadat9$Treatment, type = "t", ax.col= "black", pch = 18)
```


Or try with plotly

```{r}
require(plotly)

plot_ly(x = data_scores_3d[,1], 
        y = data_scores_3d[,2], 
        z = data_scores_3d[,3],
        type = "scatter3d",
        mode = "markers",
        color = metadat9$Treatment) # can drag this around
```

# Try anosim

```{r}
bc_dist <- vegdist(spp_mat_rare[-25,], method="bray") 

nut.ano <- anosim(bc_dist, (metadat9$Nutrients)[-25])
  summary(nut.ano)
  plot(nut.ano) 
  
crab.ano <- anosim(bc_dist, (metadat9$Crab)[-25])
  summary(crab.ano)
  plot(crab.ano) 
  
trt.ano <- anosim(bc_dist, (metadat9$Treatment)[-25])
  summary(trt.ano)
  plot(trt.ano) 

```

## What about just with core CAFI?

What are the most common CAFI?

```{r}
cafi %>% 
  group_by(coral_id, Taxa_group) %>% 
  # get abundance per taxa and coral
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  left_join(metadat9, by = "coral_id") %>% 
  ggplot(aes(x = Treatment, y = Abundance, fill = Taxa_group)) +
  geom_bar(stat = "identity") 
```


```{r}
cafi %>% 
  group_by(Taxa_group) %>% 
  # get abundance per taxa and coral
  summarize(Abundance = sum(count)) %>% 
  arrange(-Abundance) 


# seems like a cutoff of 50 is a good place to start
cafi %>% 
  group_by(Taxa_group) %>% 
  # get abundance per taxa and coral
  summarize(Abundance = sum(count)) %>% 
  arrange(-Abundance) %>% 
  filter(Abundance >= 50) -> abundant_cafi
```

```{r}
cafi %>% 
  group_by(coral_id, Taxa_group) %>% 
  # get abundance per taxa and coral
  summarize(Abundance = sum(count)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = Taxa_group, values_from = Abundance) %>% 
  # replace NA's with zeros
  mutate_all(~replace(., is.na(.), 0)) %>% 
  select(coral_id, abundant_cafi$Taxa_group) -> core_spp_matrix

core_spp_matrix %>% 
  # get rid of ID column
  select(-coral_id) -> core_spp_matrix_wide # no coral_ID
```


## Calculate distance

```{r}
nmds_core <- metaMDS(comm = core_spp_matrix_wide[-25,], # community matrix
                    k = 3, # chosen based on the scree plot
                    distance = "bray", # bray-curtis distance
                    try = 1500) # number of iterations
                    
```

See everything we can pull out:

```{r}
names(nmds_core)

nmds_core$ndim # number of axes created
nmds_core$converged # did it converge?
nmds_core$stress # what's the stress of the final solution
nmds_core$distance # type of distance
nmds_core$tries # number of random initial configuration tried
nmds_core$points # scores for each sample (coral)
nmds_core$species # scores for variables/species

# and can plot simply:
plot(nmds_core) # open black circles correspond to samples and red crosses indicate variables

```


# Plot NMDS

```{r}
# create a data frame of the scores from the individual sites.
# This data frame will contain x and y values for where sites are located.
data_scores <- as.data.frame(scores(nmds_core))
```

Now attached metadata

```{r}
data_scores <- cbind(data_scores, core_spp_matrix[-25,"coral_id"])

# add other data 
data_scores %>% 
  left_join(metadat9, by = "coral_id") -> data_scores
```

Add the scores for species data

```{r}
species_scores <- as.data.frame(scores(nmds_core, "species"))
```


Add a column equivalent to the row name

```{r}
species_scores$species <- rownames(species_scores)
```

Build the plot

```{r}
ggplot() +
  geom_point(data = data_scores, aes(x = NMDS1, y = NMDS2, 
                                     color = Treatment), size = 3) +
  annotate(geom = "label", x = -.1, y = .6, size = 10,
           label = paste("Stress: ", round(nmds_core$stress, digits = 3))) +
  theme_classic() +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  theme(legend.position = "right",
        text = element_text(size = 24))
```

Try another plot

```{r}
data_scores %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color=Treatment)) +
  stat_ellipse(type='t',size =1)+
  theme_classic() +
  geom_point()
  #geom_text(data=data_scores,aes(NMDS1, NMDS2, label=Crab), position=position_jitter(.35)) 
```



## Try anosim

```{r}
bc_dist <- vegdist(core_spp_matrix_wide[-25,], method="bray") 

nut.ano <- anosim(bc_dist, (metadat9$Nutrients)[-25])
  summary(nut.ano)
  plot(nut.ano) 
  
crab.ano <- anosim(bc_dist, (metadat9$Crab)[-25])
  summary(crab.ano)
  plot(crab.ano) 
    
trt.ano <- anosim(bc_dist, (metadat9$Treatment)[-25])
  summary(trt.ano)
  plot(trt.ano)  # Not a huge difference I don't think?

```

# PERMANOVA?
https://rpubs.com/collnell/manova

```{r}
bc_dist <- vegdist(spp_mat_rare[-25,], method="bray") 


permanov <- adonis2(bc_dist ~ Crab + Nutrients + Coral_vol, data=metadat9[-25,], permutations = 999, method="bray")

permanov

```

```{r}
dispersion<-betadisper(bc_dist, group=metadat9[-25,]$Treatment)

permutest(dispersion)
plot(dispersion, hull=FALSE, ellipse=TRUE)
```

## Permanova with the core?

```{r}
bc_dist_core <- vegdist(core_spp_matrix[-25,], method="bray") 


permanov <- adonis2(bc_dist_core ~ Crab + Nutrients + Coral_vol, data=metadat9[-25,], permutations = 999, method="bray") 


permanov

```

```{r}
dispersion_core <- betadisper(bc_dist_core, group=metadat9[-25,]$Treatment)

permutest(dispersion_core)
plot(dispersion_core, hull=FALSE, ellipse=TRUE)
```


# Look at diversity metrics


```{r}
shann.in <- diversity(spp_mat_rare, index = "shannon")
simp.in <- diversity(spp_mat_rare, index = "simpson")
invSimp.in <- diversity(spp_mat_rare, index = "invsimpson")
spp.rich <- specnumber(spp_mat_rare)

div.metrics <- cbind(shann.in, simp.in, invSimp.in, spp.rich, metadat9)
```

```{r}
# shannon
div.metrics %>% 
  ggplot(aes(x = Treatment, y = shann.in, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_manual(values = c(b.color, control.color, crab.color, n.color)) +
  ylab("Shannon diversity") +
  theme_classic()

# spp richness
div.metrics %>% 
  ggplot(aes(x = Treatment, y = spp.rich, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_manual(values = c(b.color, control.color, crab.color, n.color)) +
  ylab("Species richness") +
  theme_classic()

# shannon-crab
div.metrics %>% 
  ggplot(aes(x = Crab, y = shann.in, color = Crab)) +
  geom_boxplot() +
  theme_classic()

# simpson
div.metrics %>% 
  ggplot(aes(x = Treatment, y = simp.in, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_manual(values = c(b.color, control.color, crab.color, n.color)) +
  ylab("Simpson's index") +
  theme_classic()

# inverse simpson
div.metrics %>% 
  ggplot(aes(x = Treatment, y = invSimp.in, color = Treatment)) +
  geom_boxplot() +
  theme_classic()

```

Compare using the Hutcheson t-test ? https://www.dataanalytics.org.uk/comparing-diversity/
https://www.rdocumentation.org/packages/ecolTest/versions/0.0.1/topics/multiple_Hutcheson_t_test 

```{r}
require(ecolTest)

multiple_Hutcheson_t_test(t(spp_mat_rare)) # nope
```

What about like a Kruskal-Wallis test?

```{r}
kruskal.test(simp.in ~ Treatment, data = div.metrics)
```

Or just an ANOVA?

```{r}
div.aov <- aov(shann.in ~ Crab + Nutrients + Coral_vol, data = div.metrics)
  summary(div.aov)
```


# Gravid-ness?

```{r}
cafi %>% 
  filter(Taxa_group == "Trapeziidae") %>% 
  # fill in missing gravid lines
  mutate(Gravid = case_when(is.na(Gravid) ~ "N",
                            TRUE ~ Gravid)) -> trapeziids
```

Most females are ovigerous from the size of about 8 mm carapace width at any given time. (Rinkevich et al. 1991 Hydrobiologia). But, we found 7's with gravidness

```{r}
trapeziids %>% 
  filter(cafi_size_mm>=7,
         Gravid == "Y") %>%
  group_by(coral_id, Gravid) %>% 
  summarize(Abundance = sum(count)) %>% 
  ungroup() -> trapeziids.G

trapeziids %>% 
  filter(cafi_size_mm>=8) %>% 
  group_by(coral_id) %>% 
  summarize(LgTrap_abundance = sum(count)) %>% 
  ungroup() -> trapeziids.all


trapeziids.G %>% 
  left_join(trapeziids.all, by = "coral_id") %>% 
  mutate(Perc_graviid = Abundance/LgTrap_abundance) %>% 
  left_join(metadatint, by = "coral_id") -> gravidTraps
```

Plot

```{r}
# As a percent
gravidTraps %>% 
  ggplot(aes(x = Nutrients, y = Perc_graviid, color = Nutrients)) +
  geom_boxplot() +
  geom_jitter() +
  theme_classic()

# As a total
gravidTraps %>%  
  ggplot(aes(x = Nutrients, y = Abundance, color = Nutrients)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, height = 0.1) +
  theme_classic()

# Abundance of reproductive sized crabbos
gravidTraps %>% 
  ggplot(aes(x = Nutrients, y = LgTrap_abundance, color = Nutrients)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, height = 0.1) +
  theme_classic()

```

Try stats?

```{r}
m.gravid <- glm(Abundance ~ Nutrients + offset(log(LgTrap_abundance)), family = poisson, data = gravidTraps)
  summary (m.gravid)
```

```{r}
m.gravid2 <- glm(Abundance ~ Nutrients, family = poisson, data = gravidTraps)
  summary (m.gravid2)
```

```{r}
m.gravid3 <- glm(LgTrap_abundance ~ Nutrients, family = poisson, data = gravidTraps)
  summary (m.gravid3)
```

```{r}
gravidTraps %>% group_by(Nutrients) %>% summarize(Mean_percent = mean(Perc_graviid), SD_percent = sd(Perc_graviid), Mean_abundance = mean(Abundance), SD_percent = sd(Abundance), MeanLgAbund = mean(LgTrap_abundance), SDlgAbund = sd(LgTrap_abundance)) %>% view()


```

## Trapeziids



```{r}
trapeziids %>% 
    group_by(coral_id, cafi_size_mm) %>% 
    summarize(Abundance = sum(count)) %>% 
    ungroup() %>% 
    full_join(all_ids, by = "coral_id") %>% 
    mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                                 TRUE ~ Abundance)) %>% 
    left_join(metadatint, by = c("coral_id")) %>% 
    # calculate volume
    mutate(Coral_vol = 4/3*pi*(0.5*Height_cm)*(0.5*Longest_length_cm)*(0.5*Perpendicular_to_longest_length_cm)) -> trapeziids_size # McKeon et al. 2012 (Oecologia) calculated volume consumed as an ellipsoid (4/3𝜋𝑎𝑏𝑐, where a is half the length, b is half the width, and c is half the depth)
```

Also get one for count

```{r}
trapeziids_size %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol, TRBI_abundance) %>% 
  summarize(Abundance = sum(Abundance)) -> trapeziids_count

# or with everything but original TRBI:
trapeziids_count %>% 
  mutate(Abundance = Abundance-TRBI_abundance) -> trapeziids_count
```


### Plot it

```{r}
trapeziids_size %>% 
  ggplot(aes(x = as.integer(cafi_size_mm), fill = Treatment)) +
  geom_histogram(stat="count") +
  facet_wrap(.~Treatment) +
  theme_bw()

# versus..
trapeziids_count %>% 
  ggplot(aes(x = Crab, y = as.integer(Abundance), fill = Nutrients)) +
  scale_fill_manual(values = c(control.color, n.color)) +
  ylab("Trapeziid abundance") +
  geom_boxplot() +
  theme_bw()

# ggsave(here("figures/Trapeziidabund.jpg"), width = 4.5, height = 3, dpi = 500)

```

### Stats?

Is there a difference in Trapeziid abundance?

```{r}
m.trapeziid <- glm(Abundance ~ Crab + Nutrients +  Block + Coral_vol + Crab:Nutrients, family = poisson, data
                   =  trapeziids_count)
  summary(m.trapeziid) 
  

```

What do the predictions say?

```{r}
new.data <- new.data <- expand.grid(Crab = c("Y", "N"),
                        Nutrients = c("Y", "N"),
                        Coral_vol = mean(trapeziids_count$Coral_vol),
                        Block = c(1:10))

preds <- predict(m.trapeziid, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted Trapeziid abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_boxplot() +
  theme_classic()


# ggsave(here("figures/PredTrapeziidabund.jpg"), width = 4.5, height = 3, dpi = 500)
```


# Biomass conversions

```{r}
length_weight <- read_csv(here("data/length_weight_measurements_2021_7_12.csv"))
```

## Make a length-weight conversion for trapeziids

```{r}
length_weight %>% 
  filter(code == "TRSE" | 
           code == "TRTI" |
           code == "TRAR") %>% 
  # get rid of weird outlier
  filter(order != 175) -> trap_weight

trap_weight %>% 
  ggplot(aes(x = size, y = weight_g, color = code)) +
  geom_point() +
  scale_color_manual(values = c(crab.color, n.color, control.color)) +
  theme_classic() + 
  xlab("Trapezia size (mm)") +
  ylab("Weight (g)")

# ggsave(here("figures/TrapeziidLengthMass.jpg"), width = 4.5, height = 3, dpi = 500)
```

Looks like a curved line

```{r}
trap.LW <- lm(weight_g~poly(size,2,raw=TRUE), 
           data=trap_weight)
```

```{r}
# look at model predictions compared with observations 
preds <- predict(trap.LW, size = trap_weight$size)

trap_weight %>% 
  ggplot(aes(x = size, y = weight_g)) +
  geom_point() +
  geom_line(aes(x = trap_weight$size, y = as.numeric(preds))) +
  theme_classic()
```

So the equation is:

```{r}
get_trap_biomass <- function(size) { # size is in mm
  biomass <- as.numeric(trap.LW$coefficients[1]) + 
    as.numeric(trap.LW$coefficients[2])*size + 
    as.numeric(trap.LW$coefficients[3])*(size^2)
  return(biomass) # in grams
}
```

## Make a length-weight for COMOs

```{r}
length_weight %>% 
  filter(code == "COMO") %>% 
  mutate(Shell = case_when(notes == "shell" ~ "Y",
                           TRUE ~ "N")) %>% 
  filter(Shell == "N") -> como_weight # Need to ask Joe abou tthe "shell" notes???

como_weight %>% 
  ggplot(aes(x = size, y = weight_g)) +
  geom_point() +
  theme_classic() 
```


Looks like a curved line

```{r}
como.LW <- lm(log(weight_g)~size, 
           data = como_weight)
```

```{r}
# look at model predictions compared with observations 
preds <- predict(como.LW)

como_weight %>% 
  ggplot(aes(x = size, y = log(weight_g))) +
  geom_point() +
  geom_line(aes(x = como_weight$size, y = as.numeric(preds))) +
  theme_minimal()
```

So the equation is:

```{r}
get_como_biomass <- function(size) { # size is in mm
  biomass <- as.numeric(como.LW$coefficients[1]) + 
    as.numeric(como.LW$coefficients[2])*size 
  return(exp(biomass)) # in grams
}
```

## Make a length-weight for Alpheids

```{r}
length_weight %>% 
  filter(code == "ALLO" |
           code == "SYCH") -> alph_weight 

alph_weight %>% 
  ggplot(aes(x = size, y = weight_g, color = code)) +
  geom_point() +
  theme_minimal() # super wonky at higher values?? Maybe about the claw?
```




```{r}
alph.LW <- lm(log(weight_g)~size, 
           data = alph_weight)
```

Looks like a curved line--really don't think this is good for shrimps above, say, 30mm. Do we have any super big shrimps?

```{r}
cafi %>% 
  filter(type == "shrimp") %>% 
  arrange(-cafi_size_mm)  # Nope! biggest is like 19 so should be fine
```


```{r}
# look at model predictions compared with observations 
preds <- predict(alph.LW)

alph_weight %>% 
  ggplot(aes(x = size, y = log(weight_g))) +
  geom_point() +
  geom_line(aes(x = alph_weight$size, y = as.numeric(preds))) +
  theme_minimal() # looks not bad actually
```

So the equation is:

```{r}
get_alph_biomass <- function(size) { # size is in mm
  biomass <- as.numeric(alph.LW$coefficients[1]) + 
    as.numeric(alph.LW$coefficients[2])*size 
  return(exp(biomass)) # in grams
}
```


## Get length-weight for DAFL

```{r}
length_weight %>% 
  filter(code == "DAFL") -> dafl_weight 

dafl_weight %>% 
  ggplot(aes(x = size, y = weight_g, color = code)) +
  geom_point() +
  theme_minimal() # Looks pretty good--there's that one between 20 and 30 it's probably worth removing--maybe also the one right after 50?
```

Remove outlier:

```{r}
dafl_weight %>% 
  filter(order != 213) -> dafl_weight 
```



```{r}
dafl.LW <- lm(log(weight_g)~size, 
           data = dafl_weight)
```


```{r}
# look at model predictions compared with observations 
preds <- predict(dafl.LW)

dafl_weight %>% 
  ggplot(aes(x = size, y = log(weight_g))) +
  geom_point() +
  geom_line(aes(x = dafl_weight$size, y = as.numeric(preds))) +
  theme_minimal() # looks not bad actually
```

So the equation is:

```{r}
get_dafl_biomass <- function(size) { # size is in mm
  biomass <- as.numeric(dafl.LW$coefficients[1]) + 
    as.numeric(dafl.LW$coefficients[2])*size 
  return(exp(biomass)) # in grams
}
```

# Get length-weight for GAMA

```{r}
length_weight %>% 
  filter(code == "GAMA") -> gama_weight 

gama_weight %>% 
  ggplot(aes(x = size, y = weight_g, color = code)) +
  geom_point() +
  theme_minimal() # Looks pretty good--not a ton of data
```



```{r}
gama.LW <- lm(log(weight_g)~size, 
           data = gama_weight)
```


```{r}
# look at model predictions compared with observations 
preds <- predict(gama.LW)

gama_weight %>% 
  ggplot(aes(x = size, y = log(weight_g))) +
  geom_point() +
  geom_line(aes(x = gama_weight$size, y = as.numeric(preds))) +
  theme_minimal() # looks not bad 
```

So the equation is:

```{r}
get_gama_biomass <- function(size) { # size is in mm
  biomass <- as.numeric(gama.LW$coefficients[1]) + 
    as.numeric(gama.LW$coefficients[2])*size 
  return(exp(biomass)) # in grams
}
```

# Get HASP biomass


```{r}
length_weight %>% 
  filter(code == "HASP") -> hasp_weight 

hasp_weight %>% 
  ggplot(aes(x = size, y = weight_g, color = code)) +
  geom_point() +
  theme_minimal() # Looks pretty bad.... might not want to go forward with this one
```

JK

# Try calculating biomass for a couple

## Trapeziids

```{r}
trapeziids_size %>% 
  mutate(Biomass = get_trap_biomass(cafi_size_mm)*Abundance) %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance),
            Biomass = sum(Biomass)) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance),
         Biomass = case_when(is.na(Biomass) ~ 0,
                             TRUE ~ Biomass )) -> trapeziids_biomass
```

Plot it. Biomass:

```{r}
trapeziids_biomass %>% 
  ggplot(aes(x = Nutrients, y = Biomass, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("Trapeziid biomass") +
  geom_boxplot() +
  theme_classic()

# ggsave(here("figures/TrapeziidBiom.jpg"), width = 4.5, height = 3, dpi = 500)

```

Vs. abundance: 

```{r}
trapeziids_biomass %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("Trapezid abundance") +
  geom_boxplot() +
  theme_classic() 

# ggsave(here("figures/Trapeziidabund.jpg"), width = 4.5, height = 3, dpi = 500)

```

### Stats?

```{r}
m.trap.biom <- glm(Biomass ~ Crab + Nutrients + Crab:Nutrients + Coral_vol,
                   data = trapeziids_biomass)
  summary(m.trap.biom)
```

What do the predictions say?

```{r}
new.data <- trapeziids_biomass[,c("Crab", "Nutrients")] 
new.data <- cbind(new.data, Coral_vol = mean(trapeziids_biomass$Coral_vol))

preds <- predict(m.trap.biom, newdata = new.data, type = "response")
pred.df <- cbind(new.data, Pred = preds)

# plot
pred.df %>% 
  ggplot(aes(x = Nutrients, y = Pred, color = Crab)) +
  ylab("Predicted Trapeziid biomass") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic()


# ggsave(here("figures/PredTrapeziidbiom.jpg"), width = 4.5, height = 3, dpi = 500)
```


## DAFLS

```{r}
dafls_size %>% 
  mutate(Biomass = get_dafl_biomass(cafi_size_mm)*Abundance) %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance),
            Biomass = sum(Biomass)) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance),
         Biomass = case_when(is.na(Biomass) ~ 0,
                             TRUE ~ Biomass )) -> dafls_biomass
```

Plot it. Biomass:

```{r}
dafls_biomass %>% 
  ggplot(aes(x = Nutrients, y = Biomass, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("DAFL biomass") +
  geom_boxplot() +
  theme_classic()

# ggsave(here("figures/DAFLBiom.jpg"), width = 4.5, height = 3, dpi = 500)

```

Vs. abundance: 

```{r}
dafls_biomass %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("DAFL abundance") +
  geom_boxplot() +
  theme_classic() 
```

### Stats?

```{r}
m.dafl.biom <- glm(Biomass ~ Crab + Nutrients + Coral_vol + Block,
                   data = dafls_biomass) # no effect on biomass--could this be because of changes in little and large abundances? Basically, 
  summary(m.dafl.biom)
```

## COMOs

```{r}
comos_size %>% 
  mutate(Biomass = get_como_biomass(as.numeric(cafi_size_mm))*Abundance) %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance),
            Biomass = sum(Biomass)) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance),
         Biomass = case_when(is.na(Biomass) ~ 0,
                             TRUE ~ Biomass )) -> comos_biomass
```

Plot it. Biomass:

```{r}
comos_biomass %>% 
  ggplot(aes(x = Nutrients, y = Biomass, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("COMO biomass") +
  geom_boxplot() +
  theme_classic()

# ggsave(here("figures/COMOBiom.jpg"), width = 4.5, height = 3, dpi = 500)

```

Vs. abundance: 

```{r}
comos_biomass %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("COMO abundance") +
  geom_boxplot() +
  theme_classic() 
```

### Stats?

```{r}
m.como.biom <- glm(Biomass ~ Crab + Nutrients + Coral_vol + Block,
                   data = comos_biomass)
  summary(m.como.biom) # still an effect of crab
```


## Alpheids

```{r}
alpheids_size %>% 
  mutate(Biomass = get_alph_biomass(as.numeric(cafi_size_mm))*Abundance) %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance),
            Biomass = sum(Biomass)) %>% 
  
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance),
         Biomass = case_when(is.na(Biomass) ~ 0,
                             TRUE ~ Biomass )) -> alph_biomass
```

Plot it. Biomass:

```{r}
alph_biomass %>% 
  ggplot(aes(x = Nutrients, y = Biomass, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("Alpheid biomass") +
  geom_boxplot() +
  theme_classic()

# ggsave(here("figures/AlpheidBiom.jpg"), width = 4.5, height = 3, dpi = 500)

```

Vs. abundance: 

```{r}
alph_biomass %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  geom_boxplot() +
  theme_classic() 


```

### Stats?

```{r}
m.alph.biom <- glm(Biomass ~ Crab + Nutrients + Coral_vol + Block,
                   data = alph_biomass)
  summary(m.alph.biom) 
```


## GAMAs

```{r}
galatheids_size %>% 
  mutate(Biomass = get_gama_biomass(as.numeric(cafi_size_mm))*Abundance) %>% 
  group_by(coral_id, Block, Treatment, Crab, Nutrients, Coral_vol) %>% 
  summarize(Abundance = sum(Abundance),
            Biomass = sum(Biomass)) %>% 
  full_join(all_ids, by = "coral_id") %>% 
  mutate(Abundance = case_when(is.na(Abundance) ~ 0,
                               TRUE ~ Abundance),
         Biomass = case_when(is.na(Biomass) ~ 0,
                             TRUE ~ Biomass )) -> gamas_biomass
```

Plot it. Biomass:

```{r}
gamas_biomass %>% 
  ggplot(aes(x = Nutrients, y = Biomass, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("GAMA biomass") +
  geom_boxplot() +
  theme_classic()

# ggsave(here("figures/GAMABiom.jpg"), width = 4.5, height = 3, dpi = 500)

```

Vs. abundance: 

```{r}
gamas_biomass %>% 
  ggplot(aes(x = Nutrients, y = Abundance, fill = Crab)) +
  scale_fill_manual(values = c(control.color, crab.color)) +
  ylab("GAMA abundance") +
  geom_boxplot() +
  theme_classic() 
```

### Stats?

```{r}
m.gama.biom <- glm(Biomass ~ Crab + Nutrients + Coral_vol + Block,
                   data = gamas_biomass)
  summary(m.gama.biom) # no effects
```



# Culcita trials

Bring in the data (excludes 7/8/21, which needs more thinking)

```{r}
culcita <- read_csv(here("data/culcita_trials.csv"))
```

Replace NA's with zeros (same for this exercise) and then sum row scores

```{r}
culcita %>% 
  # don't need these columns right now
  select(-Observer, -Notes, -Cuts) %>% 
  # replace all NA's
  mutate_all(~replace(., is.na(.), 0)) %>% 
  # calculate sums based on McKeon (decided to remove Cuts and add Remove with a score of 2)
  mutate(Aggression_score = Moves*0.25 + Within_2cm*0.25 + Snaps*1 + Removed_Culcita*3) -> culcitaAggr
  
```

Get sums for each coral/date 

```{r}
culcitaAggr %>% 
  rename(coral_id = Coral) %>% 
  group_by(coral_id, Date) %>% 
  # get a cummulative aggression score
  summarise(CummAg = sum(Aggression_score)) %>% 
  ungroup() -> sumAggr
```


## Look for consistency through time points

```{r}
pdf(here("figures/cummAgScoreperCoral.pdf"), width = 6.5, height = 5)

sumAggr %>% 
  ggplot(aes(x = Date, y = CummAg, group = coral_id, color = as.factor(coral_id))) +
  geom_line() +
  ylab("Cummulative aggression score") +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size=20)) +
  scale_color_viridis_d()

dev.off()
# ggsave(here("figures/CummAggScore.jpg"), width = 7, height = 6, dpi = 500)

```

Need to figure out how to analyze repeatability, but generally looks kind of good (e.g., blue coral is always top, then brown, etc.)

Also get the mean per coral:

```{r}
sumAggr %>% 
  group_by(coral_id) %>% 
  summarize(MeanAggr = mean(CummAg)) -> meanAggr
```


## Relate to CAFI

### COMOs

First try it with COMOs (maybe where we'd expect it the most)

```{r}
comos_count %>% 
  left_join(meanAggr, by = "coral_id") %>% 
  mutate(MeanAggr = case_when(is.na(MeanAggr) ~ 0, 
                            TRUE ~ MeanAggr)) -> comoAgg
```

```{r}
# pdf(here("figures/commoabundMeanAggrNut.pdf"), width = 4.5, height = 4)

comoAgg %>% 
  filter(Crab == "Y") %>% 
  #filter(coral_id != 25) %>% 
  ggplot(aes(x = MeanAggr, y = as.integer(Abundance), color = Nutrients)) +
  ylab("COMO abundance") +
  xlab("Mean aggression score") +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  geom_point() +
  theme_classic() #+
  facet_wrap(~Nutrients)
  
# dev.off()
  
# ggsave(here("figures/AggScorevCOMO.jpg"), width = 7, height = 6, dpi = 500)
  
```

Maybe stats?

```{r}

m.comoAg <- glm(Abundance ~ MeanAggr + Coral_vol + Block + Nutrients + Nutrients:MeanAggr, 
              family = poisson, data = comoAgg) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAg)
  
  
comoAgg %>% 
  filter(coral_id != 33) -> tst

m.comoAg <- glm(Abundance ~ MeanAggr + Coral_vol + Block + Nutrients, 
              family = poisson, data = tst) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAg)
```

Hmmm what is that predicting?

```{r}
pred <- expand.grid(MeanAggr = seq(from = min(comoAgg$MeanAggr),
                         to = max(comoAgg$MeanAggr),
                         length.out = length(comoAgg$MeanAggr)),
                    Nutrients = c("Y", "N"), 
                    Coral_vol = mean(comoAgg$Coral_vol),
                    Block = c(1:10))




predCI <- as.data.frame(predict(m.comoAg,
                                pred, 
                                type = "response",
                                se.fit=TRUE)) # get standard error

predCI %>% 
  rename(PredAbund = fit,
         SE = se.fit) %>% 
  mutate(CI95 = 1.96*SE) -> predCI

pred <- cbind(pred, predCI)
  


# plot
# pdf(here("figures/commoabundMeanAggr.pdf"), width = 4.5, height = 4)

pred %>%
  filter(Block == 5) %>% 
  ggplot(aes(x = MeanAggr, y = PredAbund)) +
  ylab("Predicted COMO abundance") +
  xlab("Mean aggression score") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_ribbon(aes(ymax = PredAbund + CI95, ymin = PredAbund - CI95), alpha = 0.5, fill = control.color) +
  geom_line(color = "black") +
  #geom_point(aes(x = MeanAggr, y = as.integer(Abundance), color = Nutrients), data = comoAgg) +
  theme_classic() 

# dev.off()

# for interaction:
pred %>%
  ggplot(aes(x = MeanAggr, y = PredAbund, color = Nutrients, group = Nutrients)) +
  ylab("Predicted COMO abundance") +
  xlab("Mean aggression score") +
  geom_point() +
  theme_classic() 

```

I kinda think Coral 33 might be an outlier?

```{r}
m.comoAg33 <- glm(Abundance ~ Nutrients + MeanAggr + Coral_vol + Block, 
              family = poisson, data = subset(comoAgg, coral_id != 33)) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAg33)
  
  

```

Hmmm what is that predicting?

```{r}
pred <- expand.grid(MeanAggr = seq(from = min(comoAgg$MeanAggr),
                         to = max(comoAgg$MeanAggr),
                         length.out = length(comoAgg$MeanAggr)),
                    Nutrients = c("Y", "N"), 
                    Coral_vol = mean(comoAgg$Coral_vol))




pred$PredAbund <- predict(m.comoAg33, 
                 pred, 
                 type = "response")


# plot
pred %>% 
  ggplot(aes(x = MeanAggr, y = PredAbund, color = Nutrients)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, n.color)) +
  geom_point() +
  theme_classic() 

# ggsave(here("figures/AggScorevCOMOno33.jpg"), width = 7, height = 6, dpi = 500)

```

Which corals didn't have crabs at the end?

```{r}
culcita %>% 
  filter(Date == "7/25/21") %>% 
  # use the fact that there are NA's for observer when we didn't find a crab
  mutate(TRBI = case_when(is.na(Observer) ~ 0,
                          TRUE ~ 1)) %>% 
  rename(coral_id = Coral) %>% 
  # remove this crab column because it's confusing with the other crab column
  select(-Crab) %>% 
  left_join(metadatint, by = "coral_id") %>% 
  group_by(coral_id, Crab, Nutrients, Treatment) %>% 
  summarize(TRBI_abundance = sum(TRBI)) -> july21
```




What's the nutrient data look like?

```{r}
comoAgg %>% 
  filter(Nutrients == "Y") %>% 
  ggplot(aes(x = MeanAggr, y = Abundance)) +
  geom_point()
```


This is nonsensical because in the no crab treatments there is no aggression.. Hmmm... Maybe subset the data?

```{r}
comoAgg %>% 
  filter(Crab == "Y") %>% 
  mutate(EndTRBIAgg = MeanAggr*TRBI_abundance) -> comoAggCrab 

m.comoAgCR <- glm(Abundance ~ Nutrients + MeanAggr + Nutrients:MeanAggr + Coral_vol, 
              family = poisson, data = comoAggCrab) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAgCR)
```

```{r}
pred <- expand.grid(MeanAggr = seq(from = min(comoAggCrab$MeanAggr),
                         to = max(comoAggCrab$MeanAggr),
                         length.out = length(comoAggCrab$MeanAggr)),
                    Nutrients = c("Y", "N"), 
                    Coral_vol = mean(comoAggCrab$Coral_vol))




pred$PredAbund <- predict(m.comoAgCR, 
                 pred, 
                 type = "response")


# plot
pred %>% 
  ggplot(aes(x = MeanAggr, y = PredAbund, color = Nutrients)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic() 

```

Or what if we look at the subset we think kept the TRBI?

```{r}
comoAgg %>% 
  filter(Crab == "Y") %>% 
  filter(TRBI_abundance > 0) -> comoAggTRBI # this is a dataset of 8!!! I don't think this is a good idea?

m.comoAgTRB <- glm(Abundance ~ Nutrients + MeanAggr + Coral_vol + Block, 
              family = poisson, data = comoAggTRBI) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAgTRB)
```

```{r}
pred <- expand.grid(MeanAggr = seq(from = min(comoAggTRBI$MeanAggr),
                         to = max(comoAggTRBI$MeanAggr),
                         length.out = length(comoAggTRBI$MeanAggr)),
                    Nutrients = c("Y", "N"), 
                    Coral_vol = mean(comoAggTRBI$Coral_vol))




pred$PredAbund <- predict(m.comoAgTRB, 
                 pred, 
                 type = "response")


# plot
pred %>% 
  ggplot(aes(x = MeanAggr, y = PredAbund, color = Nutrients)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic() 

```

Plot

```{r}
comoAggTRBI %>% 
  ggplot(aes(x = MeanAggr, y = Abundance)) +
  geom_point()
```



## DAFLs

```{r}
dafls_count %>% 
  left_join(meanAggr, by = "coral_id") %>% 
  mutate(MeanAggr = case_when(is.na(MeanAggr) ~ 0, 
                            TRUE ~ MeanAggr)) -> daflAgg
```

```{r}
daflAgg %>% 
  filter(Crab == "Y") %>% 
  #filter(coral_id != 25) %>% 
  ggplot(aes(x = MeanAggr, y = as.integer(Abundance), color = Nutrients)) +
  ylab("COMO abundance") +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  geom_point() +
  theme_classic() +
  facet_wrap(~Nutrients)
```

Maybe stats?

```{r}
m.daflAg <- glm(Abundance ~ Nutrients + Crab + MeanAggr + Coral_vol + Block, 
              family = poisson, data = daflAgg) # Crab:CummAg can't be a thing because of singularities
  summary(m.daflAg)
```

Maybe subset the data?

```{r}
daflAgg %>% 
  filter(Crab == "Y") -> daflAggCrab 

m.daflAgCR <- glm(Abundance ~ Nutrients + MeanAggr + Coral_vol + Block, 
              family = poisson, data = daflAggCrab) # Crab:CummAg can't be a thing because of singularities
  summary(m.daflAgCR)
```


### Permanova?

Get culcita data joined

```{r}
metadatint %>% 
  full_join(meanAggr, by = "coral_id") %>% 
  mutate(MeanAggr = case_when(is.na(MeanAggr) ~ 0,
                              TRUE ~ MeanAggr)) -> metaCul

# if doing only a selection:
# metaCul %>% 
#   filter(coral_id != 40 & coral_id != 19 & coral_id != 25) -> # metaCul
```


```{r}
bc_dist <- vegdist(spp_mat_rare[-25,], method="bray") 


permanov <- adonis2(bc_dist ~ Crab + MeanAggr + Nutrients + Coral_vol, data=metaCul[-25,], permutations = 999, method="bray")


permanov

```


# How many had TRBI at the end?

```{r}
cafi %>% 
  filter(search_term == "Trapezia bidentata") %>% 
  ggplot(aes(x = cafi_size_mm)) +
  geom_histogram()
```

We know from initial measurements that all CAFI were at least 8mm. To account for potential measurement error, let's do 7.5mm and above

```{r}
cafi %>% 
  filter(search_term == "Trapezia bidentata") %>% 
  filter(cafi_size_mm >= 7.5) %>% 
  left_join(metadatint, by = "coral_id") -> lg_TRBI
```

How many left?

```{r}
dim(lg_TRBI) # 16
```

Do they look approximately the same size?

```{r}
lg_TRBI %>% 
  select(coral_id, count, cafi_size_mm, F_carapace_cm, M_carapace_cm, Treatment, Crab, Nutrients) 

# meh, more or less?
```



On which corals?

```{r}
 pdf(here("figures/trbiRemaining.pdf"), height = 4, width = 5.5)

lg_TRBI %>% 
  group_by(Crab, Nutrients, Treatment) %>% 
  summarize(TRBI_abundance = sum(count)) %>% 
  ggplot(aes(x = Nutrients, y = TRBI_abundance, fill = Crab)) +
  scale_fill_manual(values = c(b.color, control.color, crab.color, n.color)) +
  ylab("Original TRBI remaining") +
  geom_bar(stat = "identity") +
  theme_classic() +
  ylim(0, 20) +
  theme(text = element_text(size=20))

 dev.off()


# ggsave(here("figures/TRBIleft.jpg"), width = 7, height = 6, dpi = 500)


```

Woah that's pretty strong. Was it this selective during Culcita trials? e.g., end of summer

```{r}
culcita %>% 
  filter(Date == "7/25/21") %>% 
  # use the fact that there are NA's for observer when we didn't find a crab
  mutate(TRBI = case_when(is.na(Observer) ~ 0,
                          TRUE ~ 1)) %>% 
  rename(coral_id = Coral) %>% 
  # remove this crab column because it's confusing with the other crab column
  select(-Crab) %>% 
  left_join(metadatint, by = "coral_id") %>% 
  group_by(Crab, Nutrients, Treatment) %>% 
  summarize(TRBI_abundance = sum(TRBI)) %>% 
  ggplot(aes(x = Nutrients, y = TRBI_abundance)) +
  scale_fill_manual(values = c(b.color, control.color, crab.color, n.color)) +
  ylab("Original TRBI remaining: 7/25/21") +
  geom_col() +
  ylim(0, 20) +
  theme_classic() +
  theme(text = element_text(size=20)) 


ggsave(here("figures/TRBIleft72521.jpg"), width = 7, height = 6, dpi = 500)

```

## Look at what happens if you just use corals with TRBI at end?

```{r}
lg_TRBI %>% 
  group_by(coral_id) %>% 
  summarize(TRBI_abundance = sum(count)) -> TRBI_endAbund
```

```{r}
metaCul %>% 
  full_join(TRBI_endAbund, by = "coral_id") %>% 
  mutate(TRBI_abundance = case_when(is.na(TRBI_abundance) ~ 0,
                                   TRUE ~ TRBI_abundance)) %>% 
  mutate(EndAggr = TRBI_abundance*MeanAggr) -> metaEnd
```


```{r}
comos_count %>% 
  left_join(metaEnd, by = c("coral_id", "Crab", "Nutrients", "Treatment", "Coral_vol")) %>% 
  filter(Crab == "Y") -> comoAggEnd
```

```{r}
comoAggEnd %>% 
  ggplot(aes(x = EndAggr, y = as.integer(Abundance), color = Nutrients)) +
  ylab("COMO abundance") +
  scale_color_manual(values = c(b.color, control.color, crab.color, n.color)) +
  geom_point() +
  theme_classic() +
  facet_wrap(~Nutrients)
```

Maybe stats?

```{r}
m.comoAgEnd <- glm(Abundance ~ Nutrients + EndAggr + EndAggr:Nutrients + Coral_vol, 
              family = poisson, data = comoAggEnd) # Crab:CummAg can't be a thing because of singularities
  summary(m.comoAgEnd)
```

```{r}
pred <- expand.grid(EndAggr = seq(from = min(comoAggEnd$EndAggr),
                         to = max(comoAggEnd$EndAggr),
                         length.out = length(comoAggEnd$EndAggr)),
                    Nutrients = c("Y", "N"), 
                    Coral_vol = mean(comoAggEnd$Coral_vol))




pred$PredAbund <- predict(m.comoAgEnd, 
                 pred, 
                 type = "response")


# plot
pred %>% 
  ggplot(aes(x = EndAggr, y = PredAbund, color = Nutrients)) +
  ylab("Predicted COMO abundance") +
  scale_color_manual(values = c(control.color, crab.color)) +
  geom_point() +
  theme_classic() 

```

